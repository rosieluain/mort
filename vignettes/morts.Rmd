---
title: "Identifying potential mortalities"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Identifying potential mortalities}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup,echo=FALSE}
library(mort)
```
**Note:** vignettes are under development! We are currently developing a sample dataset, so there are some obvious gaps where there should be figures, tables, etc. These will be completed as soon as the sample dataset is done. 
<br>
<br>

Note that potential mortalities or potential cases of tag expulsion are referred to here as "mortalities" or "potential mortalities" for simplicity. 

There are two functions for identifying potential mortalities: `morts()` and `infrequent()`. 

## `morts()` function
The `morts()` function uses thresholds derived from the dataset to identify potential mortalities. There are four options for identifying thresholds and mortalities, specified with the `method` argument in `morts()`. The options "last" and "any" use a threshold derived from the duration of residence events. The option "cumulative" uses a threshold derived from cumulative residence events (defined below). The option "all" applies both "any" and "cumulative" ("last" is not called directly, as the results are also captured by "any"). 

All options rely on identifying the most recent station or location change for each animal that was detected by the array. The station change marks the last time the animal moved, and it is assumed that the animal was alive before this point. See `stationchange()` and the vignette "Digging" for more information on how mort identifies station changes. 

<!-- Use a figure from the test dataset (when available) to demonstrate this -->

### Duration of residence events
After identifying the most recent station change, the longest single residence event that occurred before the station change is identified for each animal. 

<!-- Use a figure from the test dataset to demonstrate this -->

These long residences can be explored by the user using the `resmax()` function (see the vignette "Digging" for more information). The output will look like this: 
<!-- Make a table with results of resmax from test dataset  -->

The longest residence event (highlighted in red in the table above) is used as the threshold. 

There are two options for how to apply the threshold: 

#### 1. last
The threshold is applied to the last (most recent) residence event of each animal. Any residence events that are longer than the threshold are flagged as potential mortalities. 

<!-- Actually evaluate this when dataset is ready -->
```{r morts_last_ex,eval=FALSE}
last_ex<-morts(data=data,type="mort",ID="ID",station="Station.Name",method="last")

mortsplot(data=data,type="mort",ID="ID",station="Station.Name",morts=last_ex)
```

#### 2. any
The threshold is applied to any residence event that occurred after the most recent station change for each animal. 

<!-- Actually evaluate when dataset is ready  -->
```{r morts_any_ex,eval=FALSE}
any_ex<-morts(data=data,type="mort",ID="ID",station="Station.Name",method="any")

mortsplot(data=data,type="mort",ID="ID",station="Station.Name",morts=any_ex)
```

Note in the examples above that ID and station were specified for `type="mort"`. For other supported input types, there is no default for ID and station, but they can both be specified as "auto" and will be identified automatically by mort: 

```{r actel_any_ex,eval=FALSE}
actel_ex<-morts(data=data,type="actel",ID="auto",station="auto",method="any")
```

For `type="manual"`, all required fields must be specified directly (i.e., none can be "auto"):
```{r manual_ex,eval=FALSE}
manual_ex<-morts(data=data,type="manual",ID="ID",station="Station.Name",
                 res.start="ResidenceStart",res.end="ResidenceEnd",
                 residences="ResidenceLength.days",units="days",method="any")
```

### Cumulative residence events
Cumulative residence events are the length of time between when an animal was first detected at a station and when it was last detected at the same station, ignoring any gaps in detection (or `cutoff` in `residences()`). The threshold for cumulative residence events is identified similarly to that for single residence events. The threshold is then applied to cumulative residence events that occurred after the last station change to flag potential mortalities. 

<!-- Plots of examples from dataset when ready -->

```{r cumulative_ex,eval=FALSE}
cumulative_ex<-morts(data=data,type="mort",type="ID",station="Station.Name",method="cumulative")

mortsplot(data=data,type="mort",ID="ID",station="Station.Name",morts=cumulative_ex)
```

### Notes on selecting a method
The methods outlined above may not all be relevant for all species and acoustic arrays. Choosing an appropriate method is the responsibility of the user. It is recommended to at least run all methods and explore the results. The thresholds for cumulative residence events are typically much longer than those for single residence events. Running `method="last"` will identify potential mortalities that may have occurred recently, before reaching the cumulative threshold. Conversely, `method="cumulative"` may identify potential mortalities from multiple short residence events, which each on their own would not be long enough to be identified by `method="any"`. In this way, running `method="all"` is the most conservative method. 

<!-- Actually run when dataset is ready -->
```{r all_ex,eval=FALSE}
all_ex<-morts(data=data,type="mort",type="ID",station="Station.Name",method="all")

mortsplot(data=data,type="mort",ID="ID",station="Station.Name",morts=all_ex)
```

The output of `morts()` is a dataframe, where each row is the residence event where a flagged mortality was identified: 

<!-- Make a table from all_ex -->

<!-- Make some sort of break here?  -->

## `infrequent()` function
The `infrequent()` function is used to identify potential mortalities or expelled tags that may be located just outside the usual range of a receiver, and are therefore detected briefly and intermittently when conditions allow. For this function, the thresholds are user-defined. The user has two options for defining the thresholds: 

#### 1. recent
For `method="recent"`, the timeframe for assessing infrequent residence events begins with the most recent residence event, and extends back in time for the `recent.period`. If the sum of the duration of all residence events in this timeframe is less than the `threshold`, the animal is flagged as a potential mortality. In the following example, animals are flagged if they were detected for less than 60 minutes within one year (52 weeks) preceding their most recent residence event. 

```{r recent_ex,eval=FALSE}
recent_ex<-infrequent(data=data,type="mort",ID="ID",station="Station.Name",
                      method="recent",threshold=60,threshold.units="mins",
                      recent.period=52,recent.units="weeks")

mortsplot(data=data,type="mort",ID="ID",station="Station.Name",morts=recent_ex)
```

#### 2. defined
For `method="defined"`, the timeframe for assessing infrequent residence events is specified (defined) by the user with the `start` and `end` arguments. In the following example, an animal is flagged as potential mortality if the sum of the duration of all residence events between 15 June and 15 October 2022 is less than 60 minutes. 

```{r defined_ex,eval=FALSE}
defined_ex<-infrequent(data=data,type="mort",ID="ID",station="Station.Name",
                      method="recent",threshold=60,threshold.units="mins",
                      start="2022-06-15",end="2022-10-15")

mortsplot(data=data,type="mort",ID="ID",station="Station.Name",morts=defined_ex)
```

Note that mort will assign the UTC timezone to `start` and `end`. If you want to define the period of interest using local times, it is recommended to convert local datetimes to POSIXt and then convert the timezone to UTC. 

```{r datetime_ex}
start=as.POSIXct("2022-06-15",tz="America/Edmonton")
start
attributes(start)$tzone<-"UTC"
start
```

The output of `infrequent()` is in the same format as the output of `morts()` (see above). The two output from one method can be added to the output from the other, using the `morts.prev` argument. See below for more information on using `morts.prev`.  

<!-- Make some sort of break here?  -->

## Options 
Within `morts()` and `infrequent()`, there are several optional arguments to customize the process:

### Exclude single detections
In `morts()`, the argument `singles` specifies if single detections are included as residence events. The default setting is `singles=TRUE`, to include single detections. 

Note there is no `singles` argument for `infrequent()`, because the duration of residence events from single detections is 0, and therefore does not contribute to meeting the threshold. 

### Previously identified mortalities
The `morts.prev` argument in both `morts()` and `infrequent()` specifies a dataframe of previously flagged mortalities. The input dataframe to `morts.prev` must have been previoulsy generated by mort, or have the same column names, column types, and in the same order as `data`. When new mortalities are identified, animal IDs that were already included in `morts.prev` are skipped. This option can be useful and make processing more efficient when new detection data and residence events are added to the dataset, whether from new animals that were tagged or new detections from previously tagged animals. It can also be useful when running multiple methods of identifying mortalities, since animal IDs identified in one method are skipped when running subsequent methods. 

```{r mortsprev_ex,eval=FALSE}
prev_ex<-morts(data=data,type="mort",ID="ID",station="Station.Name",morts.prev=recent_ex)
```

### Look backwards 
For both `morts()` and `infrequent()`, there is the option to look backwards (i.e., earlier) in the dataset. If the most recent station change occurred before the flagged mortality (i.e., the animal was detected earlier than the flagged mortality, at the same station, and with no detections elsewhere), the start dates and times of the flagged mortalities are shifted earlier. The default is `backwards=FALSE`; however, it is more conservative to set `backwards=TRUE`.

Note, when `method="cumulative"` and there is no seasonality, cumulative residence events will cover all consecutive detections at a given station, and `backwards` is unnecessary. 

<!-- Should give example  -->

### Drift and season
In some systems, an expelled tag or a tag from a dead animal may seem to move, due to currents or tides, or if the tag is located within range of two overlapping receivers. Both `morts()` and `infrequent()` include an option to specify stations or locations where drift may occur and to consider drift in identifying mortalities. For more information, see the "Drift" vignette. 

For some species or systems with seasonal patterns in movement or residency, it may be desirable to only consider specific seasons or periods of time when identifying mortalities. `morts()` includes an option to specify dates to calculate thresholds and flag mortalities. For more information, see the "Seasonality" vignette. Note there is no option to apply season to `infrequent()`, but the season or period of interest could be used as the defined period with `method="defined"`, as well as `start` and `end` arguments. 

